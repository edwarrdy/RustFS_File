<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RustFS æ™ºèƒ½äº‘ç›˜</title>
    <style>
      :root {
        --primary: #2563eb;
        --bg: #f8fafc;
        --card: #ffffff;
      }
      body {
        font-family: "Segoe UI", system-ui, sans-serif;
        background: var(--bg);
        color: #334155;
        max-width: 1000px;
        margin: 30px auto;
        padding: 20px;
      }
      .card {
        background: var(--card);
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        margin-bottom: 24px;
      }

      /* é¢åŒ…å±‘æ ·å¼ */
      .breadcrumb {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 20px;
        font-size: 14px;
        background: white;
        padding: 10px 15px;
        border-radius: 8px;
        border: 1px solid #e2e8f0;
      }
      .breadcrumb-item {
        color: var(--primary);
        cursor: pointer;
        font-weight: 500;
      }
      .breadcrumb-item:hover {
        text-decoration: underline;
      }
      .breadcrumb-separator {
        color: #94a3b8;
      }

      .toolbar {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
      }
      .grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
      }

      .btn {
        background: var(--primary);
        color: white;
        border: none;
        padding: 10px 18px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        transition: 0.2s;
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }
      .btn:hover {
        filter: brightness(1.1);
      }
      .btn-danger {
        background: #ef4444;
      }
      .btn-outline {
        background: white;
        border: 1px solid #cbd5e1;
        color: #475569;
      }

      table {
        width: 100%;
        border-collapse: collapse;
      }
      th {
        text-align: left;
        padding: 12px;
        border-bottom: 2px solid #f1f5f9;
        color: #64748b;
        font-size: 13px;
      }
      td {
        padding: 12px;
        border-bottom: 1px solid #f1f5f9;
        font-size: 14px;
      }

      /* æ–‡ä»¶å¤¹ä¸æ–‡ä»¶å›¾æ ‡é¢œè‰² */
      .icon-folder {
        color: #facc15;
        font-size: 18px;
        margin-right: 8px;
      }
      .icon-file {
        color: #94a3b8;
        font-size: 18px;
        margin-right: 8px;
      }
      .clickable {
        cursor: pointer;
        color: var(--primary);
        font-weight: 500;
      }

      .log-area {
        font-family: monospace;
        font-size: 12px;
        background: #1e293b;
        color: #cbd5e1;
        padding: 15px;
        border-radius: 8px;
        height: 150px;
        overflow-y: auto;
        margin-top: 20px;
      }
      #progressBarParent {
        height: 6px;
        background: #e2e8f0;
        border-radius: 3px;
        margin-top: 10px;
        display: none;
      }
      #progressBar {
        height: 100%;
        background: var(--primary);
        width: 0%;
        transition: 0.3s;
      }
    </style>
  </head>
  <body>
    <h1>ğŸš€ RustFS æ™ºèƒ½äº‘ç›˜</h1>

    <div class="breadcrumb" id="breadcrumb">
      <span class="breadcrumb-item">å…¨éƒ¨æ–‡ä»¶</span>
    </div>

    <div class="toolbar">
      <button
        class="btn"
        onclick="document.getElementById('fileInputA').click()"
      >
        ğŸ“„ ä¸­è½¬ä¸Šä¼ 
      </button>
      <button
        class="btn btn-outline"
        onclick="document.getElementById('fileInputB').click()"
      >
        âš¡ æé€Ÿç›´ä¼ 
      </button>
      <button class="btn btn-outline" onclick="promptCreateFolder()">
        ğŸ“ æ–°å»ºæ–‡ä»¶å¤¹
      </button>
      <input type="file" id="fileInputA" hidden onchange="uploadModeA()" />
      <input type="file" id="fileInputB" hidden onchange="uploadModeB()" />
    </div>

    <div id="progressBarParent"><div id="progressBar"></div></div>

    <div class="card">
      <table>
        <thead>
          <tr>
            <th>åç§°</th>
            <th style="width: 120px">å¤§å°</th>
            <th style="width: 150px">ä¸Šä¼ æ—¶é—´</th>
            <th style="width: 300px">æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="contentList"></tbody>
      </table>
    </div>

    <div class="log-area" id="logArea"></div>

    <script>
      const API_BASE = "http://localhost:3000/files";
      let currentFolderUuid = "root"; // å½“å‰ç›®å½• ID

      function log(msg, type = "") {
        const area = document.getElementById("logArea");
        const div = document.createElement("div");
        div.style.color =
          type === "error"
            ? "#f87171"
            : type === "success"
              ? "#4ade80"
              : "#cbd5e1";
        div.innerHTML = `[${new Date().toLocaleTimeString()}] ${msg}`;
        area.insertBefore(div, area.firstChild);
      }

      // --- æ ¸å¿ƒï¼šåŠ è½½ç›®å½•å†…å®¹ ---
      async function loadContent(uuid = "root") {
        currentFolderUuid = uuid;
        try {
          // 1. è·å–æ–‡ä»¶å’Œæ–‡ä»¶å¤¹
          const res = await fetch(`${API_BASE}/content?folderUuid=${uuid}`);
          const { folders, files } = await res.json();

          // 2. è·å–é¢åŒ…å±‘
          const bcRes = await fetch(
            `${API_BASE}/breadcrumbs?folderUuid=${uuid}`,
          );
          const bcData = await bcRes.json();
          renderBreadcrumbs(bcData);

          // 3. æ¸²æŸ“åˆ—è¡¨
          const list = document.getElementById("contentList");
          let html = "";

          // æ¸²æŸ“æ–‡ä»¶å¤¹
          folders.forEach((f) => {
            html += `
                        <tr>
                            <td class="clickable" onclick="loadContent('${f.uuid}')">
                                <span class="icon-folder">ğŸ“</span> ${f.displayName}
                            </td>
                            <td style="color:#94a3b8">-</td>
                            <td style="color:#64748b; font-size:13px">${f.createdAt || "-"}</td>
                            <td>
                                <button class="btn btn-outline" style="padding:4px 8px" onclick="deleteFolder('${f.uuid}')">ğŸ—‘ åˆ é™¤</button>
                            </td>
                        </tr>
                    `;
          });

          // æ¸²æŸ“æ–‡ä»¶
          files.forEach((f) => {
            html += `
                        <tr>
                            <td><span class="icon-file">ğŸ“„</span> ${f.originalName}</td>
                            <td style="color:#64748b">${formatSize(f.size)}</td>
                            <td style="color:#64748b; font-size:13px">${f.createdAt || "-"}</td>
                            <td>
                                <button class="btn btn-outline" style="padding:4px 8px" onclick="downloadModeA(${f.id})">â¬‡ æ™®é€š</button>
                                <button class="btn btn-outline" style="padding:4px 8px" onclick="downloadModeB(${f.id})">âš¡ åŠ é€Ÿ</button>
                                <button class="btn btn-danger" style="padding:4px 8px; margin-left:8px" onclick="deleteFile(${f.id})">ğŸ—‘ åˆ é™¤</button>
                            </td>
                        </tr>
                    `;
          });

          list.innerHTML =
            html ||
            '<tr><td colspan="3" style="text-align:center;color:#94a3b8">ç©ºç©ºå¦‚ä¹Ÿ</td></tr>';
        } catch (e) {
          log("åŠ è½½å¤±è´¥: " + e.message, "error");
        }
      }

      function renderBreadcrumbs(data) {
        const container = document.getElementById("breadcrumb");
        container.innerHTML = data
          .map(
            (item, index) => `
                <span class="breadcrumb-item" onclick="loadContent('${item.uuid}')">${item.displayName}</span>
                ${index < data.length - 1 ? '<span class="breadcrumb-separator">/</span>' : ""}
            `,
          )
          .join("");
      }

      // --- æ–‡ä»¶å¤¹ç®¡ç† ---
      async function promptCreateFolder() {
        const name = prompt("è¯·è¾“å…¥æ–‡ä»¶å¤¹åç§°:");
        if (!name) return;
        try {
          const res = await fetch(`${API_BASE}/folders`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              name,
              parentId: currentFolderUuid === "root" ? null : currentFolderUuid,
            }),
          });
          if (res.ok) {
            log(`æ–‡ä»¶å¤¹ "${name}" åˆ›å»ºæˆåŠŸ`, "success");
            loadContent(currentFolderUuid);
          }
        } catch (e) {
          log("åˆ›å»ºå¤±è´¥", "error");
        }
      }

      async function deleteFolder(uuid) {
        if (!confirm("ç¡®å®šé€’å½’åˆ é™¤æ–‡ä»¶å¤¹å—ï¼Ÿå†…éƒ¨æ‰€æœ‰æ–‡ä»¶éƒ½å°†è¢«æ°¸ä¹…æ¸…é™¤ï¼"))
          return;
        try {
          const res = await fetch(`${API_BASE}/folders/${uuid}`, {
            method: "DELETE",
          });
          if (res.ok) {
            log("æ–‡ä»¶å¤¹å·²æ¸…ç†", "success");
            loadContent(currentFolderUuid);
          }
        } catch (e) {
          log("åˆ é™¤å¤±è´¥", "error");
        }
      }

      // --- ä¿®æ”¹åçš„ä¸Šä¼  (Mode A) ---
      async function uploadModeA() {
        const file = document.getElementById("fileInputA").files[0];
        if (!file) return;
        const fd = new FormData();
        fd.append("file", file);
        fd.append("folderUuid", currentFolderUuid);

        try {
          log(`[Mode A] æ­£åœ¨ä¸Šä¼ è‡³å½“å‰ç›®å½•...`);
          const res = await fetch(`${API_BASE}/upload`, {
            method: "POST",
            body: fd,
          });
          if (res.ok) {
            log("ä¸Šä¼ æˆåŠŸ", "success");
            loadContent(currentFolderUuid);
          }
        } catch (e) {
          log("ä¸Šä¼ é”™è¯¯", "error");
        }
      }

      // --- ä¿®æ”¹åçš„ä¸Šä¼  (Mode B ç›´ä¼ ) ---
      async function uploadModeB() {
        const file = document.getElementById("fileInputB").files[0];
        if (!file) return;
        const bar = document.getElementById("progressBar");
        const barParent = document.getElementById("progressBarParent");

        try {
          barParent.style.display = "block";
          log(`[Mode B] ç”³è¯·åŠ é€Ÿé€šé“...`);
          const signRes = await fetch(`${API_BASE}/presigned/upload-url`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              filename: file.name,
              mimetype: file.type || "application/octet-stream",
              folderUuid: currentFolderUuid,
            }),
          });
          const signData = await signRes.json();

          log(`[Mode B] æ­£åœ¨ç›´ä¼ è‡³ RustFS...`);
          const xhr = new XMLHttpRequest();
          xhr.open("PUT", signData.uploadUrl);
          xhr.upload.onprogress = (e) => {
            if (e.lengthComputable)
              bar.style.width = (e.loaded / e.total) * 100 + "%";
          };

          xhr.onload = async () => {
            if (xhr.status < 300) {
              log(`[Mode B] åŒæ­¥å…ƒæ•°æ®...`);
              await fetch(`${API_BASE}/presigned/callback`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  key: signData.key,
                  originalName: file.name,
                  mimetype: file.type || "application/octet-stream",
                  size: file.size,
                  folderUuid: currentFolderUuid,
                }),
              });
              log("ç›´ä¼ æˆåŠŸ", "success");
              loadContent(currentFolderUuid);
            }
          };
          xhr.send(file);
        } catch (e) {
          log("ç›´ä¼ å¤±è´¥", "error");
        } finally {
          setTimeout(() => (barParent.style.display = "none"), 2000);
        }
      }

      // --- é€šç”¨åŠŸèƒ½ ---
      function formatSize(bytes) {
        if (bytes === 0) return "0 B";
        const i = Math.floor(Math.log(bytes) / Math.log(1024));
        return (
          (bytes / Math.pow(1024, i)).toFixed(2) +
          " " +
          ["B", "KB", "MB", "GB"][i]
        );
      }

      async function deleteFile(id) {
        if (!confirm("ç¡®å®šåˆ é™¤æ–‡ä»¶å—ï¼Ÿ")) return;
        const res = await fetch(`${API_BASE}/${id}`, { method: "DELETE" });
        if (res.ok) {
          log("æ–‡ä»¶å·²åˆ é™¤", "success");
          loadContent(currentFolderUuid);
        }
      }

      function downloadModeA(id) {
        window.location.href = `${API_BASE}/download/${id}`;
      }

      async function downloadModeB(id) {
        const res = await fetch(`${API_BASE}/presigned/download/${id}`);
        const data = await res.json();
        window.open(data.url, "_blank");
      }

      // åˆå§‹åŒ–åŠ è½½æ ¹ç›®å½•
      loadContent("root");
    </script>
  </body>
</html>
