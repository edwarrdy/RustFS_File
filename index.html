<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RustFS æ–‡ä»¶æœåŠ¡å™¨ (Full Features)</title>
    <style>
        :root { --primary: #2563eb; --bg: #f1f5f9; --card: #ffffff; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); color: #334155; max-width: 900px; margin: 30px auto; padding: 20px; }
        .card { background: var(--card); border-radius: 12px; padding: 24px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); margin-bottom: 24px; }
        h1 { color: #0f172a; margin-bottom: 20px; border-bottom: 2px solid #e2e8f0; padding-bottom: 10px; }
        h3 { margin-top: 0; color: #334155; }
        
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        
        .btn { background: var(--primary); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 14px; transition: 0.2s; font-weight: 500;}
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn:active { transform: translateY(0); }
        .btn:disabled { background: #cbd5e1; cursor: not-allowed; transform: none; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-success { background: #10b981; color: white; }
        .btn-outline { background: white; border: 1px solid #cbd5e1; color: #475569; }
        .btn-outline:hover { background: #f8fafc; }

        input[type="file"] { margin: 10px 0; display: block; width: 100%; font-size: 14px; }
        
        table { width: 100%; border-collapse: separate; border-spacing: 0; margin-top: 10px; }
        th { text-align: left; padding: 12px; background: #f8fafc; border-bottom: 2px solid #e2e8f0; font-size: 14px; color: #64748b; }
        td { padding: 12px; border-bottom: 1px solid #f1f5f9; font-size: 14px; vertical-align: middle; }
        tr:last-child td { border-bottom: none; }
        
        .tag { font-size: 11px; padding: 2px 8px; border-radius: 10px; background: #e0f2fe; color: #0369a1; font-family: monospace; }
        
        #progressBarParent { height: 8px; background: #e2e8f0; border-radius: 4px; margin-top: 15px; overflow: hidden; display: none; }
        #progressBar { height: 100%; background: #2563eb; width: 0%; transition: width 0.1s linear; }
        
        .log-area { font-family: 'Consolas', monospace; font-size: 12px; background: #1e293b; color: #e2e8f0; padding: 15px; border-radius: 8px; height: 200px; overflow-y: auto; line-height: 1.5; }
        .log-entry { border-bottom: 1px solid #334155; padding: 2px 0; }
        .success { color: #4ade80; } .error { color: #f87171; } .warn { color: #facc15; }
    </style>
</head>
<body>

    <h1>ğŸš€ RustFS Node.js æ§åˆ¶å°</h1>

    <div class="grid">
        <div class="card">
            <h3>ğŸ“¦ æ™®é€šä¸Šä¼  (Mode A)</h3>
            <p style="font-size:13px; color:#64748b;">æµé‡ç»è¿‡ Node.js æœåŠ¡å™¨ã€‚<br>é€‚åˆå°æ–‡ä»¶æˆ–éœ€è¦åç«¯å¤„ç†æ–‡ä»¶çš„åœºæ™¯ã€‚</p>
            <input type="file" id="fileInputA">
            <button class="btn btn-outline" onclick="uploadModeA()">Node ä¸­è½¬ä¸Šä¼ </button>
        </div>

        <div class="card" style="border: 2px solid #e0f2fe;">
            <h3>âš¡ æé€Ÿç›´ä¼  (Mode B)</h3>
            <p style="font-size:13px; color:#64748b;">å‰ç«¯ç›´æ¥å¯¹æ¥ RustFSã€‚<br>é€‚åˆå¤§æ–‡ä»¶ï¼Œä¸å ç”¨æœåŠ¡å™¨å¸¦å®½ã€‚</p>
            <input type="file" id="fileInputB">
            <div id="progressBarParent"><div id="progressBar"></div></div>
            <button class="btn btn-success" id="btnB" onclick="uploadModeB()" style="margin-top:10px; width:100%">ğŸš€ å¼€å§‹ç›´ä¼ </button>
        </div>
    </div>

    <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h3>ğŸ“‚ äº‘ç«¯æ–‡ä»¶åˆ—è¡¨</h3>
            <button class="btn btn-outline" onclick="loadFiles()">ğŸ”„ åˆ·æ–°</button>
        </div>
        <table>
            <thead>
                <tr>
                    <th style="width: 50px">ID</th>
                    <th>æ–‡ä»¶å</th>
                    <th style="width: 100px">å¤§å°</th>
                    <th style="width: 260px">æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="fileList"></tbody>
        </table>
    </div>

    <div class="log-area" id="logArea">
        <div class="log-entry">ç³»ç»Ÿå°±ç»ªï¼Œç­‰å¾…æ“ä½œ...</div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3000/files';

        function log(msg, type = '') {
            const area = document.getElementById('logArea');
            const div = document.createElement('div');
            div.className = `log-entry ${type}`;
            div.innerHTML = `<span style="opacity:0.5">[${new Date().toLocaleTimeString()}]</span> ${msg}`;
            area.insertBefore(div, area.firstChild);
        }

        function formatSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024, sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // --- æ¨¡å¼ A ä¸Šä¼  ---
        async function uploadModeA() {
            const file = document.getElementById('fileInputA').files[0];
            if (!file) return alert('è¯·é€‰æ‹©æ–‡ä»¶');
            
            const fd = new FormData();
            fd.append('file', file);
            
            try {
                log(`[Mode A] å¼€å§‹ä¸Šä¼ : ${file.name}`);
                const res = await fetch(`${API_BASE}/upload`, { method: 'POST', body: fd });
                const json = await res.json();
                if(!res.ok) throw new Error(json.error);
                
                log(`âœ… ä¸Šä¼ æˆåŠŸ (ID: ${json.data.id})`, 'success');
                loadFiles();
            } catch (e) { log(`âŒ å¤±è´¥: ${e.message}`, 'error'); }
        }

        // --- æ¨¡å¼ B ç›´ä¼  ---
        async function uploadModeB() {
            const file = document.getElementById('fileInputB').files[0];
            if (!file) return alert('è¯·é€‰æ‹©æ–‡ä»¶');
            
            const btn = document.getElementById('btnB');
            const bar = document.getElementById('progressBar');
            const barParent = document.getElementById('progressBarParent');
            
            try {
                btn.disabled = true;
                barParent.style.display = 'block';
                bar.style.width = '0%';
                
                log(`[Mode B] 1. è·å–ç­¾å URL...`);
                const signRes = await fetch(`${API_BASE}/presigned/upload-url`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ filename: file.name, mimetype: file.type || 'application/octet-stream' })
                });
                const signData = await signRes.json();
                if(!signRes.ok) throw new Error('ç­¾åè·å–å¤±è´¥');

                log(`[Mode B] 2. ç›´ä¼  RustFS...`);
                await new Promise((resolve, reject) => {
                    const xhr = new XMLHttpRequest();
                    xhr.open('PUT', signData.uploadUrl);
                    xhr.setRequestHeader('Content-Type', file.type || 'application/octet-stream');
                    xhr.upload.onprogress = e => {
                        if(e.lengthComputable) bar.style.width = (e.loaded/e.total*100) + '%';
                    };
                    xhr.onload = () => xhr.status < 300 ? resolve() : reject(`RustFS error ${xhr.status}`);
                    xhr.onerror = () => reject('ç½‘ç»œä¸­æ–­');
                    xhr.send(file);
                });

                log(`[Mode B] 3. ä¿å­˜å…ƒæ•°æ®...`);
                await fetch(`${API_BASE}/presigned/callback`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        key: signData.key,
                        originalName: file.name,
                        mimetype: file.type || 'application/octet-stream',
                        size: file.size
                    })
                });

                log(`âœ… ç›´ä¼ æµç¨‹å®Œæˆ!`, 'success');
                loadFiles();
            } catch (e) {
                log(`âŒ ç›´ä¼ å¤±è´¥: ${e}`, 'error');
            } finally {
                btn.disabled = false;
                setTimeout(() => barParent.style.display = 'none', 1000);
            }
        }

        // --- æ ¸å¿ƒï¼šä¸‹è½½ä¸åˆ é™¤ ---
        function downloadModeA(id) {
            log(`â¬‡ æ­£åœ¨è¯·æ±‚æ™®é€šä¸‹è½½ (ID:${id})...`);
            // ç›´æ¥ç”±æµè§ˆå™¨å¯¼èˆªï¼Œè§¦å‘ä¸‹è½½
            window.location.href = `${API_BASE}/download/${id}`;
        }

        async function downloadModeB(id) {
            try {
                log(`âš¡ æ­£åœ¨è·å–åŠ é€Ÿé“¾æ¥ (ID:${id})...`);
                const res = await fetch(`${API_BASE}/presigned/download/${id}`);
                const data = await res.json();
                if(!res.ok) throw new Error(data.error);

                log(`ğŸ”— è¿æ¥è·å–æˆåŠŸï¼Œæ‰“å¼€ä¸‹è½½...`, 'success');
                // æ‰“å¼€æ–°çª—å£ä¸‹è½½
                window.open(data.url, '_blank');
            } catch (e) {
                log(`âŒ åŠ é€Ÿä¸‹è½½å¤±è´¥: ${e.message}`, 'error');
            }
        }

        async function deleteFile(id) {
            if(!confirm('ç¡®å®šåˆ é™¤å—ï¼Ÿæ–‡ä»¶å°†ä¸å¯æ¢å¤ã€‚')) return;
            try {
                log(`ğŸ—‘ æ­£åœ¨åˆ é™¤ (ID:${id})...`);
                const res = await fetch(`${API_BASE}/${id}`, { method: 'DELETE' });
                if(res.ok) {
                    log(`âœ… åˆ é™¤æˆåŠŸ`, 'success');
                    loadFiles();
                } else {
                    throw new Error('æœåŠ¡å™¨è¿”å›é”™è¯¯');
                }
            } catch (e) {
                log(`âŒ åˆ é™¤å¤±è´¥: ${e.message}`, 'error');
            }
        }

        async function loadFiles() {
            try {
                const res = await fetch(API_BASE);
                const files = await res.json();
                const html = files.map(f => `
                    <tr>
                        <td><span class="tag">#${f.id}</span></td>
                        <td><strong>${f.originalName}</strong></td>
                        <td style="color:#64748b">${formatSize(f.size)}</td>
                        <td>
                            <button class="btn btn-outline" style="font-size:12px; padding:4px 8px;" onclick="downloadModeA(${f.id})">â¬‡ æ™®é€š</button>
                            <button class="btn btn-success" style="font-size:12px; padding:4px 8px;" onclick="downloadModeB(${f.id})">âš¡ åŠ é€Ÿ</button>
                            <button class="btn btn-danger" style="font-size:12px; padding:4px 8px; margin-left:10px" onclick="deleteFile(${f.id})">ğŸ—‘ åˆ é™¤</button>
                        </td>
                    </tr>
                `).join('');
                document.getElementById('fileList').innerHTML = html || '<tr><td colspan="4" style="text-align:center; padding:20px">æš‚æ— æ–‡ä»¶</td></tr>';
            } catch (e) {
                log(`åˆ—è¡¨åŠ è½½å¤±è´¥: ${e.message}`, 'error');
            }
        }

        loadFiles();
    </script>
</body>
</html>