---
---

# RustFS Node.js File Server

è¿™æ˜¯ä¸€ä¸ªåŸºäº **Node.js** çš„é«˜æ€§èƒ½æ–‡ä»¶æœåŠ¡å™¨ä¸­é—´ä»¶ï¼Œä¸“ä¸º **RustFS** (åŠå…¶ä»– S3 å…¼å®¹å¯¹è±¡å­˜å‚¨) è®¾è®¡ã€‚

å®ƒé‡‡ç”¨ **Better-SQLite3** ä½œä¸ºå…ƒæ•°æ®å­˜å‚¨ï¼Œ**AWS SDK v3** ä½œä¸ºå­˜å‚¨å®¢æˆ·ç«¯ï¼Œæ”¯æŒ **æœåŠ¡å™¨ä¸­è½¬ (Proxy)** å’Œ **ç›´è¿ (Presigned URL)** ä¸¤ç§ä¼ è¾“æ¨¡å¼ï¼Œå®Œç¾è§£å†³äº†å¤§æ–‡ä»¶ä¼ è¾“æ•ˆç‡ä¸ç½‘ç»œæŠ–åŠ¨é—®é¢˜ã€‚

## âœ¨ æ ¸å¿ƒç‰¹æ€§

- **åŒæ¨¡å¼ä¼ è¾“**ï¼š
- ğŸ“¦ **Mode A (ä¸­è½¬)**ï¼šæµå¼ç»è¿‡åç«¯ï¼Œé€‚åˆå°æ–‡ä»¶ã€æƒé™æ§åˆ¶ã€‚
- âš¡ **Mode B (ç›´ä¼ )**ï¼šå‰ç«¯ç›´æ¥å¯¹æ¥ RustFSï¼Œåç«¯ä»…è´Ÿè´£ç­¾åã€‚**é›¶å¸¦å®½æ¶ˆè€—**ï¼Œæ”¯æŒ GB çº§å¤§æ–‡ä»¶ã€‚

- **æ•°æ®ä¸€è‡´æ€§**ï¼š
- ğŸ›¡ï¸ **åŸå­åˆ é™¤**ï¼šä¸¥æ ¼éµå¾ªâ€œå…ˆåˆ äº‘ç«¯ï¼Œååˆ æœ¬åœ°â€åŸåˆ™ï¼Œé˜²æ­¢å‡ºç°â€œå‡åˆ é™¤â€ç°è±¡ã€‚
- ğŸ“„ **å…ƒæ•°æ®ç®¡ç†**ï¼šä½¿ç”¨ SQLite è®°å½•åŸå§‹æ–‡ä»¶åã€MIME ç±»å‹å’Œå¤§å°ã€‚

- **ç”¨æˆ·ä½“éªŒä¼˜åŒ–**ï¼š
- â¬‡ï¸ **æ™ºèƒ½ä¸‹è½½**ï¼šè‡ªåŠ¨å¤„ç† `Content-Disposition`ï¼Œç¡®ä¿ä¸‹è½½æ—¶æ˜¾ç¤ºåŸå§‹æ–‡ä»¶åï¼ˆæ”¯æŒä¸­æ–‡/ç‰¹æ®Šå­—ç¬¦ï¼‰ã€‚
- â±ï¸ **æŠ—ç½‘ç»œæŠ–åŠ¨**ï¼šé…ç½®äº†é•¿è¶…æ—¶æ—¶é—´ï¼ˆSocket Timeoutï¼‰ï¼Œé€‚åº”å¤§æ–‡ä»¶æ“ä½œã€‚

- **è½»é‡é«˜æ•ˆ**ï¼š
- ç§»é™¤ Prismaï¼Œæ”¹ç”¨ **better-sqlite3**ï¼Œé›¶ä¾èµ–è¿›ç¨‹ï¼Œç§’çº§å¯åŠ¨ã€‚
- å®Œå…¨ç§»é™¤æ—§ç‰ˆ SDKï¼Œé‡‡ç”¨æ¨¡å—åŒ–çš„ AWS SDK v3ã€‚

## ğŸ› ï¸ æŠ€æœ¯æ ˆ

- **Runtime**: Node.js (Express)
- **Database**: SQLite (via `better-sqlite3`)
- **Storage Client**: `@aws-sdk/client-s3` (v3)
- **Presigner**: `@aws-sdk/s3-request-presigner`

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. ç¯å¢ƒå‡†å¤‡

- Node.js v16+
- RustFS æœåŠ¡å·²å¯åŠ¨ï¼ˆæˆ– MinIO/S3ï¼‰

### 2. å®‰è£…ä¾èµ–

```bash
npm install express multer cors dotenv better-sqlite3
npm install @aws-sdk/client-s3 @aws-sdk/s3-request-presigner @smithy/node-http-handler

```

### 3. é…ç½®æ–‡ä»¶ (.env)

åœ¨æ ¹ç›®å½•åˆ›å»º `.env` æ–‡ä»¶ï¼Œå¡«å…¥ä»¥ä¸‹é…ç½®ï¼š

```env
# æœåŠ¡å™¨ç«¯å£
PORT=3000

# æ•°æ®åº“è·¯å¾„ (è‡ªåŠ¨åˆ›å»º)
DATABASE_URL="file:./file-server.db"

# RustFS / S3 é…ç½®
RUSTFS_ENDPOINT="http://192.168.1.100:9000"  # ä½ çš„ RustFS åœ°å€
RUSTFS_REGION="us-east-1"                   # åŒºåŸŸ (RustFS é»˜è®¤é€šå¸¸å¯å¡« us-east-1)
RUSTFS_ACCESS_KEY="rustfsadmin"             # Access Key
RUSTFS_SECRET_KEY="rustfssecret"            # Secret Key
RUSTFS_BUCKET_NAME="my-bucket"              # å­˜å‚¨æ¡¶åç§°

```

### 4. å¯åŠ¨æœåŠ¡

```bash
# å¼€å‘æ¨¡å¼ (æ¨èï¼Œä»£ç å˜åŠ¨è‡ªåŠ¨é‡å¯)
npm install -D nodemon
npm run dev

# ç”Ÿäº§æ¨¡å¼
npm start

```

å¯åŠ¨æˆåŠŸåï¼Œæ§åˆ¶å°å°†è¾“å‡ºï¼š

```text
ğŸš€ Server running on http://localhost:3000
ğŸ“‚ Database: SQLite (via better-sqlite3)
â˜ï¸  Storage:  RustFS (S3 Compatible)
[Init] Bucket 'my-bucket' created or verified.

```

## ğŸ§ª å‰ç«¯æµ‹è¯•å°

é¡¹ç›®åŒ…å«ä¸€ä¸ªå•æ–‡ä»¶ HTML æµ‹è¯•é¡µé¢ï¼Œä½äºæ ¹ç›®å½•ï¼ˆæˆ–æ‚¨åˆ›å»ºçš„ï¼‰ `index.html`ã€‚
åŒå‡»æ‰“å¼€æˆ–é€šè¿‡ VS Code Live Server æ‰“å¼€å³å¯è¿›è¡Œä»¥ä¸‹æµ‹è¯•ï¼š

1. **æ™®é€šä¸Šä¼ **ï¼šæµ‹è¯• Mode A ä¸­è½¬èƒ½åŠ›ã€‚
2. **æé€Ÿç›´ä¼ **ï¼šæµ‹è¯• Mode B è¿›åº¦æ¡åŠå¤§æ–‡ä»¶ä¸Šä¼ èƒ½åŠ›ã€‚
3. **ä¸‹è½½**ï¼šæµ‹è¯•æ–‡ä»¶åæ˜¯å¦æ­£ç¡®è¿˜åŸã€‚
4. **åˆ é™¤**ï¼šæµ‹è¯• 3G+ å¤§æ–‡ä»¶çš„åˆ é™¤ä¸€è‡´æ€§ã€‚

## ğŸ“š API æ–‡æ¡£

åŸºç¡€è·¯å¾„: `http://localhost:3000/files`

### 1. ä¸Šä¼ æ¥å£

| æ¥å£                  | æ–¹æ³• | æè¿°           | Body å‚æ•°                                                                    |
| --------------------- | ---- | -------------- | ---------------------------------------------------------------------------- |
| /upload               | POST | Mode A (ä¸­è½¬)  | multipart/form-dataï¼ˆfile: äºŒè¿›åˆ¶æ–‡ä»¶ï¼‰                                      |
| /presigned/upload-url | POST | Mode B (ç¬¬1æ­¥) | { "filename": "a.mp4", "mimetype": "video/mp4" }                             |
| /presigned/callback   | POST | Mode B (ç¬¬2æ­¥) | { "key": "uuid...", "originalName": "...", "size": 1024, "mimetype": "..." } |

### 2. ä¸‹è½½æ¥å£

| æ¥å£                    | æ–¹æ³• | æè¿°   | å¤‡æ³¨                                                                  |
| ----------------------- | ---- | ------ | --------------------------------------------------------------------- |
| /download/:id           | GET  | Mode A | æµå¼ä¸‹è½½ï¼ˆå“åº”å¤´åŒ…å« Content-Dispositionï¼‰                            |
| /presigned/download/:id | GET  | Mode B | è·å–ä¸´æ—¶ç›´é“¾ï¼ˆè¿”å› { "url": "http://rustfs...", "filename": "..." }ï¼‰ |

### 3. ç®¡ç†æ¥å£

| æ¥å£   | æ–¹æ³•   | æè¿°                            |
| ------ | ------ | ------------------------------- |
| `/`    | GET    | è·å–æ–‡ä»¶åˆ—è¡¨                    |
| `/:id` | DELETE | åˆ é™¤æ–‡ä»¶ (å…ˆåˆ äº‘ç«¯ï¼Œååˆ æ•°æ®åº“) |

## ğŸ“‚ é¡¹ç›®ç»“æ„

```text
node-rustfs-server/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ config/
â”‚   â”‚   â”œâ”€â”€ db.js          # SQLite åˆå§‹åŒ–ä¸è¿æ¥ (Better-SQLite3)
â”‚   â”‚   â””â”€â”€ s3.js          # AWS SDK v3 é…ç½® (å«è¶…æ—¶è®¾ç½®)
â”‚   â”œâ”€â”€ controllers/
â”‚   â”‚   â””â”€â”€ fileController.js  # è¯·æ±‚å¤„ç†å±‚
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â””â”€â”€ fileService.js     # æ ¸å¿ƒä¸šåŠ¡å±‚ (SQLæ“ä½œ + S3å‘½ä»¤)
â”‚   â”œâ”€â”€ routes/
â”‚   â”‚   â””â”€â”€ fileRoutes.js      # è·¯ç”±å®šä¹‰
â”‚   â””â”€â”€ middlewares/
â”‚       â””â”€â”€ upload.js          # Multer é™åˆ¶é…ç½®
â”œâ”€â”€ server.js              # å…¥å£æ–‡ä»¶
â”œâ”€â”€ index.html             # å‰ç«¯æµ‹è¯•é¡µé¢
â”œâ”€â”€ .env                   # é…ç½®æ–‡ä»¶
â””â”€â”€ package.json

```

## âš ï¸ å¸¸è§é—®é¢˜ (Troubleshooting)

1. **CORS é”™è¯¯ (Mode B ç›´ä¼ æ—¶)**

- ç°è±¡ï¼šå‰ç«¯ Console æŠ¥é”™ `Access to XMLHttpRequest ... has been blocked by CORS policy`ã€‚
- åŸå› ï¼šæµè§ˆå™¨ç›´æ¥è®¿é—® RustFSï¼Œä½† RustFS æœªé…ç½®å…è®¸è·¨åŸŸã€‚
- è§£å†³ï¼šéœ€åœ¨ RustFS/MinIO ç«¯é…ç½® Bucket çš„ CORS è§„åˆ™ï¼Œå…è®¸ `PUT` æ–¹æ³•å’Œæ‰€æœ‰ Origin (`*`)ã€‚

2. **ä¸Šä¼ è¶…æ—¶ (Timeout)**

- ç°è±¡ï¼šä¸Šä¼ è¶…å¤§æ–‡ä»¶æ—¶ Node.js æŠ¥é”™ `SocketHangUp`ã€‚
- è§£å†³ï¼šæˆ‘ä»¬åœ¨ `src/config/s3.js` ä¸­å·²å°† `socketTimeout` è®¾ç½®ä¸º 3åˆ†é’Ÿã€‚å¦‚æœæ–‡ä»¶æå¤§ï¼Œè¯·å°½é‡ä½¿ç”¨ **Mode B (ç›´ä¼ )**ï¼Œå› ä¸ºå®ƒä¸ç»è¿‡ Node.jsï¼Œä¸å— Node è¶…æ—¶é™åˆ¶ã€‚

3. **ä¸‹è½½æ–‡ä»¶åä¹±ç **

- é¡¹ç›®å·²å†…ç½® RFC 5987 æ ‡å‡†æ”¯æŒ (`filename*=UTF-8''...`)ï¼Œè¯·ç¡®ä¿ä½¿ç”¨ç°ä»£æµè§ˆå™¨ï¼ˆChrome/Edge/Firefoxï¼‰è¿›è¡Œæµ‹è¯•ã€‚

---

**License**: MIT
